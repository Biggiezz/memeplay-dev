// Test Deploy Script - Local Network Only
// This script tests the deploy process on Hardhat local network
// No real gas fees, no real network needed

const hre = require("hardhat");
const fs = require("fs");
const path = require("path");

async function main() {
  console.log("üß™ Testing deploy script on local Hardhat network...\n");

  // Get the contract factory
  const AvatarNFT = await hre.ethers.getContractFactory("AvatarNFT");
  
  console.log("üì¶ Deploying contract...");
  const avatarNFT = await AvatarNFT.deploy();
  
  await avatarNFT.waitForDeployment();
  const address = await avatarNFT.getAddress();

  console.log("‚úÖ Contract deployed to:", address);
  console.log("üìù Contract address:", address);

  // Read ABI from artifact file
  const artifactPath = path.join(
    __dirname,
    "../artifacts/contracts/AvatarNFT.sol/AvatarNFT.json"
  );
  
  if (!fs.existsSync(artifactPath)) {
    console.error("‚ùå Artifact file not found:", artifactPath);
    console.log("üí° Run 'npm run compile' first!");
    process.exit(1);
  }

  const artifact = JSON.parse(fs.readFileSync(artifactPath, "utf8"));
  const abi = artifact.abi;

  // Path to contract-address.js
  const contractAddressPath = path.join(__dirname, "../../src/contract-address.js");

  // Generate contract-address.js file
  const contractAddressContent = `// Auto-generated contract address and ABI (LOCAL TEST)
// Generated at: ${new Date().toISOString()}
// DO NOT EDIT MANUALLY - This file is auto-generated by deploy script
// NOTE: This is a LOCAL TEST deployment, address will be different on real network

export const CONTRACT_ADDRESS = "${address}";
export const CONTRACT_NETWORK = "hardhat"; // Local network
export const CONTRACT_CHAIN_ID = 1337; // Hardhat default chain ID

// Contract ABI for frontend interaction
export const CONTRACT_ABI = ${JSON.stringify(abi, null, 2)};
`;

  // Write to file
  fs.writeFileSync(contractAddressPath, contractAddressContent);
  
  console.log("\n‚úÖ Contract address and ABI saved to: avatar-system/src/contract-address.js");
  console.log(`üì¶ ABI contains ${abi.length} items (functions, events, errors)`);

  // Test contract functions
  console.log("\nüß™ Testing contract functions...");
  
  const [owner, user1] = await hre.ethers.getSigners();
  console.log("üë§ Test user address:", user1.address);

  // Test mint
  console.log("üìù Testing mintAvatar function...");
  const configHash = "0x12345678";
  const tx = await avatarNFT.mintAvatar(user1.address, configHash);
  await tx.wait();
  console.log("‚úÖ Mint successful!");

  // Test query functions
  console.log("üîç Testing query functions...");
  const hasMinted = await avatarNFT.hasMinted(user1.address);
  const tokenId = await avatarNFT.getAvatarByOwner(user1.address);
  const storedHash = await avatarNFT.getConfigHash(tokenId);
  const totalSupply = await avatarNFT.totalSupply();

  console.log("  - hasMinted:", hasMinted);
  console.log("  - tokenId:", tokenId.toString());
  console.log("  - configHash:", storedHash);
  console.log("  - totalSupply:", totalSupply.toString());

  // Verify results
  if (hasMinted && tokenId.toString() === "0" && storedHash === configHash && totalSupply.toString() === "1") {
    console.log("\n‚úÖ All tests passed!");
  } else {
    console.log("\n‚ùå Some tests failed!");
    process.exit(1);
  }

  console.log("\nüéâ Deploy script test completed successfully!");
  console.log("üí° You can now deploy to Base Sepolia with: npm run deploy:base-sepolia");
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error("‚ùå Error:", error);
    process.exit(1);
  });

