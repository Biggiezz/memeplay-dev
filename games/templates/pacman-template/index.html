<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Pacman Template - MVP1</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <script>
    (function() {
      try {
        var searchParams = new URLSearchParams(window.location.search || '');
        var hash = window.location.hash || '';
        var pathname = window.location.pathname || '';
        var hasGameId = false;
        var detectedGameId = null;
        
        if (searchParams.get('game')) {
          hasGameId = true;
          detectedGameId = searchParams.get('game');
        }
        
        if (!hasGameId && hash) {
          var normalizedHash = hash.replace(/^#/, '').trim();
          if (normalizedHash.startsWith('/?')) {
            normalizedHash = normalizedHash.slice(2);
          }
          if (normalizedHash.includes('game=')) {
            var hashQuery = normalizedHash.includes('?') ? normalizedHash.split('?')[1] : normalizedHash;
            var hashParams = new URLSearchParams(hashQuery);
            var hashGameId = hashParams.get('game');
            if (hashGameId) {
              hasGameId = true;
              detectedGameId = hashGameId;
            }
          } else if (normalizedHash.startsWith('pacman-game-')) {
            hasGameId = true;
            detectedGameId = normalizedHash;
          }
        }
        
        if (!hasGameId && pathname && /\/pacman-game-[^/]+$/.test(pathname)) {
          hasGameId = true;
          detectedGameId = pathname.split('/').pop();
        }
        
        var editorFlagKey = detectedGameId ? `pacman_editor_mode_${detectedGameId}` : null;
        var prefersEditorMode = editorFlagKey ? localStorage.getItem(editorFlagKey) === 'true' : false;
        
        var addPublicViewClass = function() {
          if (!document.body) return;
          if (!document.body.classList.contains('public-game-view')) {
            document.body.classList.add('public-game-view');
          }
        };
        
        if (hasGameId && !prefersEditorMode) {
          if (document.body) {
            addPublicViewClass();
          } else {
            document.addEventListener('DOMContentLoaded', addPublicViewClass, { once: true });
            setTimeout(addPublicViewClass, 0);
          }
          console.log('[Pacman] ‚úÖ Added public-game-view class (early detection)');
        } else if (prefersEditorMode) {
          console.log('[Pacman] ‚úèÔ∏è Editor mode preferred, skipping public-game-view class');
        }
      } catch (err) {
        console.warn('[Pacman] Failed to set public-game-view class early:', err);
      }
    })();
  </script>
  <div id="creatorScreen">
    <!-- ====================================
         EDITOR PANEL
         ==================================== -->
    <div id="editorContainer" class="editor-container">
      <div class="editor-panel">
        <h2 style="color: #FFFFFF; margin-bottom: 20px;">Game Editor</h2>
        
        <!-- Template Selection -->
        <div class="editor-group">
          <label class="editor-label" for="templateSelect">Template</label>
          <select id="templateSelect" class="editor-input" style="cursor: pointer;">
            <option value="pacman" selected>Pacman</option>
            <option value="blocks-8x8">Blocks 8x8</option>
            <option value="wall-bounce-bird">Wall Bounce Bird</option>
            <option value="blow-bubble">Blow Bubble</option>
          </select>
        </div>
        
        <!-- Logo -->
        <div class="editor-group">
          <label class="editor-label">Logo</label>
          <input type="file" id="fragmentLogoInput" class="editor-file-input" accept="image/png,image/jpeg,image/jpg,image/webp,image/gif">
          <label for="fragmentLogoInput" class="editor-file-label">Upload Logo</label>
          <div id="fragmentLogoLoading" style="display: none; color: #ffb642; font-size: 12px; margin-top: 5px;">Processing image...</div>
          <img id="fragmentLogoPreview" class="logo-preview" alt="Fragment Logo Preview">
        </div>
        
        <!-- Game Title (Auto-generated, hidden) -->
        <div class="editor-group" style="display: none;">
          <label class="editor-label">Game Title</label>
          <input type="text" id="titleInput" class="editor-input" placeholder="Enter game title">
        </div>
        
        <!-- Story 1 -->
        <div class="editor-group">
          <label class="editor-label">Story 1 <span id="story1Count" class="char-count">0/50</span></label>
          <textarea id="story1Input" class="editor-textarea" placeholder="Enter story text (max 50 characters)..." maxlength="50"></textarea>
        </div>
        
        <!-- Map Selection -->
        <div class="editor-group template-section template-pacman">
          <label class="editor-label">Map</label>
          <select id="mapSelect" class="editor-input" style="cursor: pointer;">
            <option value="1">Map 1</option>
            <option value="2">Map 2</option>
            <option value="3">Map 3</option>
            <option value="4" class="disabled-option" disabled>Map 4</option>
            <option value="5" class="disabled-option" disabled>Map 5</option>
          </select>
        </div>
        
        <!-- Map Color -->
        <div class="editor-group template-section template-pacman">
          <label class="editor-label">Map Color</label>
          <div class="map-color-picker">
            <button type="button" class="map-color-btn" data-color="#6B46C1" style="--color:#6B46C1;" aria-label="Purple map color" aria-pressed="false"></button>
            <button type="button" class="map-color-btn" data-color="#000000" style="--color:#000000;" aria-label="Black map color" aria-pressed="false"></button>
            <button type="button" class="map-color-btn" data-color="#8B4513" style="--color:#8B4513;" aria-label="Brown map color" aria-pressed="false"></button>
          </div>
        </div>
        <div class="editor-group template-section template-wall-bounce-bird" style="display: none;">
          <label class="editor-label">Background Color</label>
          <div class="map-color-picker">
            <button type="button" class="map-color-btn" data-color="#b8e0d2" style="--color:#b8e0d2;" aria-label="Mint green background" aria-pressed="false"></button>
            <button type="button" class="map-color-btn" data-color="#98fb98" style="--color:#98fb98;" aria-label="Pale green background" aria-pressed="false"></button>
            <button type="button" class="map-color-btn" data-color="#87ceeb" style="--color:#87ceeb;" aria-label="Sky blue background" aria-pressed="false"></button>
          </div>
        </div>
        <div class="editor-group template-section template-blow-bubble" style="display: none;">
          <label class="editor-label">Background Color</label>
          <div class="map-color-picker">
            <button type="button" class="map-color-btn" data-color="#6B46C1" style="--color:#6B46C1;" aria-label="Purple background" aria-pressed="false"></button>
            <button type="button" class="map-color-btn" data-color="#10B981" style="--color:#10B981;" aria-label="Green background" aria-pressed="false"></button>
            <button type="button" class="map-color-btn" data-color="#87CEEB" style="--color:#87CEEB;" aria-label="Sky blue background" aria-pressed="false"></button>
          </div>
        </div>
        
        
        <!-- Buttons -->
        <button id="playTestBtn" class="editor-btn">Play Test</button>
        <button id="closeEditorBtn" class="editor-btn secondary">Close Editor</button>
        
        <!-- Save and Get Public Link buttons - shown after Play Test (Desktop only) -->
        <button id="saveBtn" class="editor-btn" style="display: none; margin-top: 10px;">üíæ Save</button>
        <button id="publicLinkBtn" class="editor-btn disabled" style="display: none; margin-top: 10px;">üîó Get Public Link</button>
      </div>

      <div class="editor-canvas">
        <div id="pacmanEditorPreview" class="game-wrapper">
          <canvas id="gameCanvasEditor" style="background: #0f0f1e;"></canvas>
        </div>
        <div id="blocksEditorPreview" class="blocks-editor-preview" style="visibility: hidden; opacity: 0; position: absolute;">
          <iframe
            id="blocksEditorFrame"
            src="../../crypto-blocks/index.html"
            title="Blocks 8x8 Preview"
            width="720"
            height="1000"
            frameborder="0"
            allowfullscreen>
          </iframe>
        </div>
        <div id="wallBounceBirdEditorPreview" class="wall-bounce-bird-editor-preview" style="visibility: hidden; opacity: 0; position: absolute;">
          <iframe
            id="wallBounceBirdEditorFrame"
            src="../../wall-bounce-bird/index.html"
            title="Wall Bounce Bird Preview"
            width="720"
            height="1000"
            frameborder="0"
            allowfullscreen>
          </iframe>
        </div>
        <div id="blowBubbleEditorPreview" class="blow-bubble-editor-preview" style="visibility: hidden; opacity: 0; position: absolute;">
          <iframe
            id="blowBubbleEditorFrame"
            src="../../blow-bubble/index.html"
            title="Blow Bubble Preview"
            width="720"
            height="1000"
            frameborder="0"
            allowfullscreen>
          </iframe>
        </div>
      </div>
    </div>
    
    <div class="creator-floating-buttons">
      <!-- Row 1: Icon buttons (back and close) -->
      <div class="button-row">
        <button id="editorToggle" class="floating-btn icon-btn" title="Back">‚Üê</button>
        <button id="closeHomeBtn" class="floating-btn icon-btn" title="Close">√ó</button>
      </div>
      
      <!-- Row 2: Save and Get Public Link (Mobile only) -->
      <div class="button-row">
        <button id="saveBtnMobile" class="floating-btn" style="display: none;">üíæ Save</button>
        <button id="publicLinkBtnMobile" class="floating-btn disabled" style="display: none;">üîó Get Public Link</button>
      </div>
    </div>
  </div>
  
  <!-- ====================================
       GAME WRAPPER
       ==================================== -->
  <div id="gameWrapper">
    <div class="game-wrapper">
      <div id="pacmanGameView">
      <!-- ====================================
           HUD (Heads-Up Display)
           ==================================== -->
      <div class="hud">
        <div class="hud-left">
          <div class="hud-info">
            <div id="hudScore" class="hud-score">Score: 0</div>
            <div id="hudLevel" class="hud-level">LV 1</div>
          </div>
        </div>
      </div>
      
      <!-- Canvas (only game area: 700x730) -->
      <canvas id="gameCanvas" width="700" height="730" tabindex="0"></canvas>
      
      <!-- ====================================
           FOCUS TOGGLE BUTTON
           ==================================== -->
      <button class="focus-toggle" aria-label="Toggle focus mode" aria-pressed="false" title="Toggle focus mode">‚§¢</button>
      
      <!-- ====================================
           MOBILE CONTROLS
           ==================================== -->
      <div class="mobile-controls">
        <div class="control-row">
          <button id="btnUp" class="control-btn up">‚ñ≤</button>
        </div>
        <div class="control-row">
          <button id="btnLeft" class="control-btn">‚óÑ</button>
          <button id="btnDown" class="control-btn">‚ñº</button>
          <button id="btnRight" class="control-btn">‚ñ∫</button>
        </div>
      </div>
      
      <!-- ====================================
           GAME OVER SCREEN
           ==================================== -->
      <div class="game-over-screen">
        <img id="gameOverLogo" class="game-over-logo" src="" alt="Fragment Logo" style="display: none;">
        <div id="gameOverStory" class="game-over-story"></div>
        <button id="restartBtn" class="restart-btn">Play Again</button>
      </div>
      </div>
    </div>
  </div>
  
  <div id="blocksWrapper" class="blocks-template-view" style="display: none;">
    <iframe
      id="blocksGameFrame"
      src="../../crypto-blocks/index.html"
      title="Blocks 8x8"
      width="720"
      height="1000"
      frameborder="0"
      allowfullscreen>
    </iframe>
  </div>
  
  <div id="wallBounceBirdWrapper" class="wall-bounce-bird-template-view" style="display: none;">
    <iframe
      id="wallBounceBirdGameFrame"
      src="../../wall-bounce-bird/index.html"
      title="Wall Bounce Bird"
      width="720"
      height="1000"
      frameborder="0"
      allowfullscreen>
    </iframe>
  </div>
  
  <div id="blowBubbleWrapper" class="blow-bubble-template-view" style="display: none;">
    <iframe
      id="blowBubbleGameFrame"
      src="../../blow-bubble/index.html"
      title="Blow Bubble"
      width="720"
      height="1000"
      frameborder="0"
      allowfullscreen>
    </iframe>
  </div>
  
  <!-- ====================================
       SCRIPTS
       ==================================== -->
  <script src="config.js"></script>
  <script>
    (function() {
      try {
        if (typeof getGameId === 'function') {
          var gameId = getGameId();
          if (gameId) {
            var editorFlagKey = `pacman_editor_mode_${gameId}`;
            var prefersEditorMode = localStorage.getItem(editorFlagKey) === 'true';
            if (!prefersEditorMode && document.body && !document.body.classList.contains('public-game-view')) {
              document.body.classList.add('public-game-view');
              console.log('[Pacman] ‚úÖ Added public-game-view class (post-config) for game', gameId);
            }
          }
        }
      } catch (err) {
        console.warn('[Pacman] Failed to set public-game-view class after config.js:', err);
      }
    })();
  </script>
  <script src="maps.js"></script>
  <!-- Supabase client will be created lazily in game.js when needed -->
  <!-- This prevents local network permission prompt on page load -->
  <script src="game.js"></script>
  <script>
    (function() {
      const BASE_WIDTH = 720;
      const BASE_HEIGHT = 1070; // includes padding for HUD / controls
      
      function applyGameScale() {
        const wrapper = document.getElementById('gameWrapper');
        if (!wrapper) return;
        const inner = wrapper.querySelector('.game-wrapper');
        if (!inner) return;
        const availableWidth = wrapper.clientWidth;
        const scale = Math.min(1, availableWidth / BASE_WIDTH);
        inner.style.transform = `scale(${scale})`;
        inner.style.transformOrigin = 'top center';
        wrapper.style.height = `${BASE_HEIGHT * scale}px`;
      }
      
      window.addEventListener('resize', applyGameScale);
      window.addEventListener('orientationchange', applyGameScale);
      document.addEventListener('DOMContentLoaded', applyGameScale);
    })();
  </script>
</body>
</html>

